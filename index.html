<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ø¨Ø§Ø²Ø§Ø± Ù…Ø§Ø´ÛŒÙ†â€ŒÙ‡Ø§ÛŒ Ø³Ù†Ú¯ÛŒÙ†</title>

  <!-- Supabase JS (Ø¨Ø±Ø§ÛŒ Ú©Ù„Ø§ÛŒÙ†Øª ÙØ±Ø§Ù†Øª) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- Telegram SDK Ùˆ SortableJS -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>

  <style>
    body{font-family:sans-serif;margin:0;padding:16px;background:var(--tg-theme-bg-color,#fff);color:var(--tg-theme-text-color,#111)}
    .wrap{max-width:980px;margin:0 auto}
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:900px){ .grid{grid-template-columns: 300px 1fr} }
    .card{background:var(--tg-theme-secondary-bg-color,#f5f5f5);border-radius:16px;padding:12px;box-shadow:0 2px 10px rgba(0,0,0,.06)}
    h1{margin:0 0 8px}
    h2{margin:8px 0;font-size:16px;opacity:.85}
    label{display:block;margin-top:8px}
    input,select,textarea{width:100%;padding:8px;border-radius:10px;border:1px solid #ddd;background:transparent;color:inherit}
    button{padding:10px 14px;border-radius:10px;border:0;cursor:pointer}
    .btn{background:var(--tg-theme-button-color,#2ea6ff);color:var(--tg-theme-button-text-color,#fff)}
    .pill{font-size:12px;opacity:.8}
    .item{border:1px solid #ddd;border-radius:12px;padding:10px;margin:8px 0;background:rgba(0,0,0,.02)}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    .hidden{display:none}
    .gallery{display:flex;gap:6px;overflow:auto}
    .gallery img{height:64px;border-radius:8px;cursor:zoom-in}
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.8);display:none;align-items:center;justify-content:center}
    .modal img{max-width:95vw;max-height:90vh;border-radius:8px}
    .handle{cursor:grab;font-weight:bold;padding:0 8px}
    #debug{font:12px monospace;opacity:.8;white-space:pre-wrap;direction:ltr}
    .sold{color:#0a7a12;font-weight:bold}
    .filters .row>div{flex:1;min-width:120px}
  </style>
</head>
<body>
<div class="wrap">

  <div class="card"><h1>Ø¨Ø§Ø²Ø§Ø± Ú©Ø§Ù…ÛŒÙˆÙ† Ùˆ Ú©Ø´Ù†Ø¯Ù‡</h1><div id="welcome" class="pill"></div></div>

  <div class="grid">
    <!-- ÙÛŒÙ„ØªØ±Ù‡Ø§ -->
    <div class="card filters">
      <h2>ÙÛŒÙ„ØªØ±Ù‡Ø§</h2>
      <div class="row">
        <div>
          <label>Ø¨Ø±Ù†Ø¯</label>
          <select id="f_brand"></select>
        </div>
        <div>
          <label>Ø³Ø§Ù„</label>
          <input id="f_year" type="number" placeholder="Ù…Ø«Ù„Ø§Ù‹ 1398">
        </div>
      </div>
      <div class="row">
        <div>
          <label>Ù‚ÛŒÙ…Øª Ø§Ø² (Ù…ÛŒÙ„ÛŒØ§Ø±Ø¯)</label>
          <input id="f_min" type="number" min="0" max="20" step="0.1" placeholder="0">
        </div>
        <div>
          <label>ØªØ§ (Ù…ÛŒÙ„ÛŒØ§Ø±Ø¯)</label>
          <input id="f_max" type="number" min="0" max="20" step="0.1" placeholder="20">
        </div>
      </div>
      <div class="row">
        <label><input type="checkbox" id="f_used"> Ú©Ø§Ø±Ú©Ø±Ø¯Ù‡</label>
        <label><input type="checkbox" id="f_zero"> ØµÙØ±</label>
      </div>
      <div class="row">
        <label><input type="checkbox" id="f_birang"> Ø¨ÛŒâ€ŒØ±Ù†Ú¯</label>
        <label><input type="checkbox" id="f_bedun"> Ø¨Ø¯ÙˆÙ† Ø¢Ø¨Ø±Ù†Ú¯</label>
      </div>
      <div class="row">
        <label><input type="checkbox" id="f_retarder"> Ø±ÛŒØªØ§Ø±Ø¯</label>
        <label><input type="checkbox" id="f_intarder"> Ø§ÛŒÙ†ØªØ§Ø±Ø¯</label>
      </div>
      <div class="row" style="margin-top:8px">
        <button class="btn" id="applyFilters">Ø§Ø¹Ù…Ø§Ù„</button>
        <button id="resetFilters">Ø±ÛŒØ³Øª</button>
      </div>

      <h2 style="margin-top:16px">Ù„ÛŒÙ†Ú©â€ŒÙ‡Ø§</h2>
      <div class="row">
        <a class="btn" href="https://instagram.com/truck.mirakhorli" target="_blank" style="text-decoration:none;text-align:center;flex:1">Ù¾ÛŒØ¬ Ø§ÛŒÙ†Ø³ØªØ§Ú¯Ø±Ø§Ù…</a>
        <a class="btn" href="tel:09121314226" style="text-decoration:none;text-align:center;flex:1">ØªÙ…Ø§Ø³ Ø¨Ø§ Ù…Ø´Ø§ÙˆØ±</a>
      </div>
    </div>

    <!-- Ù„ÛŒØ³Øª Ù¾Ø³Øªâ€ŒÙ‡Ø§ -->
    <div class="card">
      <div id="posts"></div>
    </div>
  </div>

  <!-- Ù¾Ù†Ù„ Ø§Ø¯Ù…ÛŒÙ† -->
  <div id="adminPanel" class="card hidden">
    <h2>Ù¾Ù†Ù„ Ø§Ø¯Ù…ÛŒÙ† ğŸ‘‘</h2>

    <div class="row">
      <button id="adminLoginBtn">ÙˆØ±ÙˆØ¯ Ø§Ø¯Ù…ÛŒÙ† (username/password)</button>
      <span id="adminLoginStatus" class="pill"></span>
    </div>

    <h3>ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù…Ø­ØªÙˆØ§</h3>
    <label>Ù…ØªÙ† Ø®ÙˆØ´â€ŒØ¢Ù…Ø¯</label>
    <textarea id="welcomeInput" rows="2"></textarea>

    <h4 class="pill">Ù…Ù†Ùˆ (Drag & Drop)</h4>
    <ul id="menuEditor"></ul>
    <div class="row">
      <input id="newTitle" placeholder="Ø¹Ù†ÙˆØ§Ù† Ù…Ù†Ùˆ"/>
      <input id="newPath" placeholder="Ù…Ø³ÛŒØ± Ù…Ø«Ù„ / ÛŒØ§ /about"/>
      <button id="addItemBtn">Ø§ÙØ²ÙˆØ¯Ù† Ø¢ÛŒØªÙ…</button>
    </div>

    <h4 class="pill" style="margin-top:12px">Ø¨Ù„ÙˆÚ©â€ŒÙ‡Ø§ (Drag & Drop)</h4>
    <div id="blocksEditor"></div>
    <div class="row">
      <select id="blockType">
        <option value="text">Ù…ØªÙ†</option><option value="image">ØªØµÙˆÛŒØ±</option><option value="button">Ø¯Ú©Ù…Ù‡</option>
      </select>
      <button id="addBlockBtn">Ø§ÙØ²ÙˆØ¯Ù† Ø¨Ù„ÙˆÚ©</button>
    </div>

    <div class="row" style="margin-top:8px">
      <button class="btn" id="saveConfig">Ø°Ø®ÛŒØ±Ù‡ ØªÙ†Ø¸ÛŒÙ…Ø§Øª</button>
      <span id="saveConfigStatus" class="pill"></span>
    </div>

    <hr/>

    <h3>Ù¾Ø³Øª Ø¬Ø¯ÛŒØ¯ / ÙˆÛŒØ±Ø§ÛŒØ´</h3>
    <div class="row">
      <input id="p_id" type="hidden">
      <input id="p_title" placeholder="Ø¹Ù†ÙˆØ§Ù†">
      <input id="p_brand" placeholder="Ø¨Ø±Ù†Ø¯ (Ù…Ø«Ù„Ø§Ù‹ Volvo)">
      <input id="p_subbrand" placeholder="Ø³Ø±ÛŒ/Ù…Ø¯Ù„ (Ù…Ø«Ù„Ø§Ù‹ FH)">
    </div>
    <div class="row">
      <input id="p_year" type="number" placeholder="Ø³Ø§Ù„">
      <input id="p_price" type="number" placeholder="Ù‚ÛŒÙ…Øª (ØªÙˆÙ…Ø§Ù†)">
      <input id="p_mileage" type="number" placeholder="Ú©Ø§Ø±Ú©Ø±Ø¯ (Ú©ÛŒÙ„ÙˆÙ…ØªØ±)">
    </div>
    <div class="row">
      <label><input type="checkbox" id="p_used" checked> Ú©Ø§Ø±Ú©Ø±Ø¯Ù‡</label>
      <label><input type="checkbox" id="p_birang"> Ø¨ÛŒâ€ŒØ±Ù†Ú¯</label>
      <label><input type="checkbox" id="p_bedun"> Ø¨Ø¯ÙˆÙ† Ø¢Ø¨Ø±Ù†Ú¯</label>
      <label><input type="checkbox" id="p_retarder"> Ø±ÛŒØªØ§Ø±Ø¯</label>
      <label><input type="checkbox" id="p_intarder"> Ø§ÛŒÙ†ØªØ§Ø±Ø¯</label>
      <label><input type="checkbox" id="p_sold"> ÙØ±ÙˆØ®ØªÙ‡â€ŒØ´Ø¯Ù‡</label>
    </div>
    <label>Ù„ÛŒÙ†Ú© Ù¾Ø³Øª Ø§ÛŒÙ†Ø³ØªØ§Ú¯Ø±Ø§Ù…</label>
    <input id="p_insta" placeholder="https://instagram.com/....">
    <label>ØªÙˆØ¶ÛŒØ­Ø§Øª</label>
    <textarea id="p_desc" rows="3"></textarea>

    <label>ØªØµØ§ÙˆÛŒØ± (Ø¯Ø±Ú¯â€ŒØ§ÙÙ†Ø¯â€ŒØ¯Ø±Ø§Ù¾ ÛŒØ§ Ø§Ù†ØªØ®Ø§Ø¨ ÙØ§ÛŒÙ„)</label>
    <input id="p_images" type="file" multiple accept="image/*">
    <div id="p_gallery" class="gallery"></div>

    <div class="row" style="margin-top:8px">
      <button class="btn" id="savePost">Ø«Ø¨Øª/Ø°Ø®ÛŒØ±Ù‡</button>
      <span id="savePostStatus" class="pill"></span>
    </div>

    <h3>Ø±Ù…Ø²Ø³Ø§Ø² (ÙÙ‚Ø· Owner)</h3>
    <div class="row">
      <button id="genPwd" class="btn">Ø³Ø§Ø®Øª ÛŒÙˆØ²Ø±Ù†ÛŒÙ…/Ù¾Ø³ÙˆØ±Ø¯ Ø§Ø¯Ù…ÛŒÙ† ÙˆÛŒØ±Ø§ÛŒØ´Ú¯Ø±</button>
      <input id="rvkUser" placeholder="username Ø¨Ø±Ø§ÛŒ revoke">
      <button id="revokeBtn">Revoke</button>
      <span id="genStatus" class="pill"></span>
    </div>

    <h3>Ù†Ù…ÙˆØ¯Ø§Ø± Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ (Ø¨Ø§Ø²Ø¯ÛŒØ¯/Ú©Ù„ÛŒÚ©)</h3>
    <div id="stats" class="pill">Ø¨Ù‡â€ŒØ²ÙˆØ¯ÛŒ (Data Ø¯Ø± audit_logs Ø°Ø®ÛŒØ±Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯)</div>
  </div>

  <div id="debug" class="card">startingâ€¦</div>
</div>

<!-- Ù…Ø¯Ø§Ù„ Ø¨Ø²Ø±Ú¯â€ŒÙ†Ù…Ø§ÛŒÛŒ -->
<div id="modal" class="modal" onclick="this.style.display='none'">
  <img id="modalImg" src="">
</div>

<script>
(function(){
  const tg = window.Telegram?.WebApp; tg?.expand();
  const debug = (...a)=>{ const el=document.getElementById('debug'); el.textContent += '\n'+a.map(x=>{try{return typeof x==='string'?x:JSON.stringify(x)}catch{return String(x)}}).join(' '); };
  const $ = s => document.querySelector(s);

  // Ú©Ù„Ø§ÛŒÙ†Øª Supabase Ø¨Ø±Ø§ÛŒ ÙØ±Ø§Ù†Øª (Ø¨Ø®Ø´ Â«Ø¨Â»)
  let SUPA = null;
  async function initSupabaseClient(){
    const r = await fetch('/api/public');
    const j = await r.json();
    SUPA = window.supabase.createClient(j.supabaseUrl, j.supabaseAnon);
  }

  // Ø¨Ø±Ù†Ø¯Ù‡Ø§
  const BRANDS = {
    "Volvo":["FH","FM","FMX","F12","F16"],
    "Scania":["R","S","P","G","T"],
    "Mercedes-Benz":["Actros","Axor","Atego"],
    "MAN":["TGX","TGS","TGA","F2000"],
    "DAF":["XF","CF","LF"],
    "Iveco":["Stralis","Trakker","Eurocargo"],
    "Renault":["T","C","K","Magnum","Premium"],
    "Kamaz":["5490","6520","6460"],
    "Howo":["A7","T7H","T5G"],
    "FAW":["JH6","J5P"],
    "Dongfeng":["KX","KL","KC"],
    "Shacman":["X3000","X5000","M3000"]
  };

  const state = {
    role:'public', token:'', username:'',
    config:{ welcome_text:'', menu:[], blocks:[] },
    uploads:[]
  };

  function esc(s){ return String(s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m])) }
  function formatPrice(x){ if(!x) return 'â€”'; return (Number(x)/1e9).toFixed(2).replace(/\.00$/,'') + ' Ù…ÛŒÙ„ÛŒØ§Ø±Ø¯'; }

  async function getMe(){
    const init = tg?.initData || '';
    const q = new URLSearchParams({ initData:init, token:state.token }).toString();
    const r = await fetch('/api/me?'+q);
    const j = await r.json();
    state.role = j.role || 'public';
    state.username = j.username || '';
    $('#adminPanel').classList.toggle('hidden', !j.is_admin);
    $('#adminLoginStatus').textContent = j.is_admin ? `ÙˆØ±ÙˆØ¯: ${state.role}` : 'ÙˆØ§Ø±Ø¯ Ù†Ø´Ø¯Ù‡';
    debug('me â†’', j);
  }
  async function loginEditor(){
    const u = prompt('Username:'); if(u==null) return;
    const p = prompt('Password:'); if(p==null) return;
    const r = await fetch('/api/login',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({username:u,password:p})});
    const j = await r.json();
    if(j.ok){ state.token=j.token; state.role=j.role; state.username=u; $('#adminLoginStatus').textContent='ÙˆØ±ÙˆØ¯ Ù…ÙˆÙÙ‚'; await getMe(); }
    else alert('Ø®Ø·Ø§ÛŒ Ù„Ø§Ú¯ÛŒÙ†');
  }
  $('#adminLoginBtn').onclick = loginEditor;

  async function loadConfig(){
    const r = await fetch('/api/config'); const j = await r.json();
    state.config = Object.assign({welcome_text:'',menu:[],blocks:[]}, j||{});
    $('#welcome').textContent = state.config.welcome_text || '';
    renderMenuEditor(); renderBlocksEditor();
  }

  function renderMenuEditor(){
    const ul = $('#menuEditor'); ul.innerHTML='';
    (state.config.menu||[]).forEach((it,idx)=>ul.appendChild(menuRow(it,idx)));
    new Sortable(ul,{handle:'.handle',animation:150,onEnd:()=>{ const rows=[...ul.querySelectorAll('li')]; state.config.menu=rows.map(li=>({title:li.dataset.title,path:li.dataset.path})) }});
  }
  function menuRow(it,idx){
    const li=document.createElement('li'); li.className='item'; li.dataset.title=it.title||''; li.dataset.path=it.path||'';
    li.innerHTML=`<span class="handle">â˜°</span><div class="grow"><b>${esc(it.title)}</b><div class="pill">${esc(it.path)}</div></div><button data-act="edit">ÙˆÛŒØ±Ø§ÛŒØ´</button><button data-act="del">Ø­Ø°Ù</button>`;
    li.onclick=e=>{
      const act=e.target?.dataset?.act;
      if(act==='del'){ state.config.menu.splice(idx,1); renderMenuEditor(); }
      if(act==='edit'){ const t=prompt('Ø¹Ù†ÙˆØ§Ù†',li.dataset.title||''); if(t==null)return; const p=prompt('Ù…Ø³ÛŒØ±',li.dataset.path||''); if(p==null)return; state.config.menu[idx]={title:t,path:p}; renderMenuEditor(); }
    };
    return li;
  }

  function renderBlocksEditor(){
    const box = $('#blocksEditor'); box.innerHTML='';
    (state.config.blocks||[]).forEach((b,idx)=> box.appendChild(blockRow(b,idx)) );
    new Sortable(box,{handle:'.handle',animation:150,onEnd:()=>{ const rows=[...box.children]; state.config.blocks=rows.map(el=>JSON.parse(el.dataset.block)) }});
  }
  function blockRow(b,idx){
    const el=document.createElement('div'); el.className='item'; el.dataset.block=JSON.stringify(b);
    el.innerHTML=`<span class="handle">â˜°</span><div class="grow">${blockSummary(b)}</div><button data-act="edit">ÙˆÛŒØ±Ø§ÛŒØ´</button><button data-act="del">Ø­Ø°Ù</button>`;
    el.onclick=e=>{
      const act=e.target?.dataset?.act;
      if(act==='del'){ state.config.blocks.splice(idx,1); renderBlocksEditor(); }
      if(act==='edit'){ editBlock(b,(nb)=>{ state.config.blocks[idx]=nb; renderBlocksEditor(); }); }
    };
    return el;
  }
  function blockSummary(b){
    if(b.type==='text')   return `<b>Ù…ØªÙ†:</b> <span class="pill">${esc((b.text||'').slice(0,50))}</span>`;
    if(b.type==='image')  return `<b>ØªØµÙˆÛŒØ±:</b> <span class="pill">${esc(b.url||'')}</span>`;
    if(b.type==='button') return `<b>Ø¯Ú©Ù…Ù‡:</b> ${esc(b.text||'')} â†’ <span class="pill">${esc(b.href||'')}</span>`;
    return 'Unknown block';
  }
  function editBlock(b,onSave){
    if(b.type==='text'){ const t=prompt('Ù…ØªÙ†:',b.text||''); if(t==null)return; onSave({type:'text',text:t}); }
    if(b.type==='image'){ const u=prompt('Ø¢Ø¯Ø±Ø³ ØªØµÙˆÛŒØ±:',b.url||''); if(u==null)return; const alt=prompt('ALT:',b.alt||''); if(alt==null)return; const cap=prompt('Ú©Ù¾Ø´Ù†:',b.caption||''); if(cap==null)return; onSave({type:'image',url:u,alt,caption:cap}); }
    if(b.type==='button'){ const t=prompt('Ù…ØªÙ† Ø¯Ú©Ù…Ù‡:',b.text||''); if(t==null)return; const h=prompt('Href (Ù…Ø«Ù„Ø§Ù‹ /go):',b.href||''); if(h==null)return; onSave({type:'button',text:t,href:h}); }
  }
  $('#addItemBtn').onclick = ()=>{ const t=$('#newTitle').value.trim();const p=$('#newPath').value.trim(); if(!t)return; state.config.menu.push({title:t,path:p||'/'}); $('#newTitle').value='';$('#newPath').value=''; renderMenuEditor(); };
  $('#addBlockBtn').onclick = ()=>{ const type=$('#blockType').value; const def= type==='text'?{type:'text',text:'Ù…ØªÙ† Ù†Ù…ÙˆÙ†Ù‡'}: type==='image'?{type:'image',url:'https://placehold.co/800x400',alt:'',caption:''}:{type:'button',text:'Ø¨Ø²Ù† Ø¨Ø±ÛŒÙ…',href:'/go'}; state.config.blocks.push(def); renderBlocksEditor(); };
  $('#saveConfig').onclick = async ()=>{ const s=$('#saveConfigStatus'); s.textContent='Ø¯Ø± Ø­Ø§Ù„ Ø°Ø®ÛŒØ±Ù‡â€¦'; const r= await fetch('/api/config',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({initData: tg?.initData||'', config:{ welcome_text:$('#welcomeInput').value, menu:state.config.menu, blocks:state.config.blocks }})}); const j= await r.json(); s.textContent = j.ok?'Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯ âœ…':'Ø®Ø·Ø§: '+(j.error||''); };

  // ÙÙ‡Ø±Ø³Øª Ùˆ ÙÛŒÙ„ØªØ± Ù¾Ø³Øªâ€ŒÙ‡Ø§
  function fillBrandFilter(){ const sel = $('#f_brand'); sel.innerHTML='<option value="">Ù‡Ù…Ù‡ Ø¨Ø±Ù†Ø¯Ù‡Ø§</option>'; Object.keys(BRANDS).forEach(b=>{ const o=document.createElement('option'); o.value=b;o.textContent=b; sel.appendChild(o); }); }
  async function loadPosts(){
    const p = new URLSearchParams();
    const b=$('#f_brand').value; if(b) p.set('brand',b);
    const y=$('#f_year').value; if(y) p.set('year',y);
    const min=$('#f_min').value; if(min) p.set('minp',Math.floor(parseFloat(min||0)*1e9));
    const max=$('#f_max').value; if(max) p.set('maxp',Math.floor(parseFloat(max||0)*1e9));
    if($('#f_used').checked && !$('#f_zero').checked) p.set('used','true');
    if($('#f_zero').checked && !$('#f_used').checked) p.set('used','false');
    if($('#f_birang').checked) p.set('birang','true');
    if($('#f_bedun').checked) p.set('bedun','true');
    if($('#f_retarder').checked) p.set('retarder','true');
    if($('#f_intarder').checked) p.set('intarder','true');
    const r = await fetch('/api/posts?'+p.toString());
    const j = await r.json(); renderPosts(j.items||[]);
  }
  function renderPosts(items){
    const box = $('#posts'); box.innerHTML='';
    items.forEach(p=>{
      const card=document.createElement('div'); card.className='item';
      const title= `${esc(p.brand||'')} ${esc(p.subbrand||'')} â€” ${esc(p.title||'')}`;
      card.innerHTML = `
        <div class="row" style="justify-content:space-between;align-items:center">
          <div><b>${title}</b> <span class="pill">Ø³Ø§Ù„ ${p.year||'â€”'}</span></div>
          <div>${p.sold?'<span class="sold">âœ… ÙØ±ÙˆØ®ØªÙ‡ Ø´Ø¯Ù‡ Ø§Ø³Øª</span>':''}</div>
        </div>
        <div class="pill">${formatPrice(p.price_toman)}</div>
        <div class="gallery"></div>
        <div class="pill">${esc(p.description||'')}</div>
        <div class="row" style="margin-top:6px">
          ${p.insta_url?`<a class="btn" href="${esc(p.insta_url)}" target="_blank" style="text-decoration:none">Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø¯Ø± Ø§ÛŒÙ†Ø³ØªØ§Ú¯Ø±Ø§Ù…</a>`:''}
          <a class="btn" href="tel:09121314226" style="text-decoration:none">ØªÙ…Ø§Ø³ Ø¨Ø§ Ù…Ø´Ø§ÙˆØ±</a>
        </div>
        ${state.role!=='public'
          ? `<div class="row" style="margin-top:6px">
               <label><input type="checkbox" data-act="sold" ${p.sold?'checked':''}> ÙØ±ÙˆØ®ØªÙ‡ Ø´Ø¯</label>
               <button data-act="edit">ÙˆÛŒØ±Ø§ÛŒØ´</button>
             </div>` : '' }
      `;
      const g = card.querySelector('.gallery');
      (p.images||[]).forEach(url=>{ const img=document.createElement('img'); img.src=url; img.onclick=()=>openModal(url); g.appendChild(img); });
      card.onclick = async (e)=>{
        if(e.target?.dataset?.act==='sold'){
          const sold = e.target.checked;
          await fetch('/api/posts',{method:'PATCH',headers:{'Content-Type':'application/json'},body:JSON.stringify({ id:p.id, sold, initData: tg?.initData||'', editorUser: state.role==='editor'?state.username:undefined })});
          loadPosts();
        }
        if(e.target?.dataset?.act==='edit'){
          $('#p_id').value=p.id; $('#p_title').value=p.title||''; $('#p_brand').value=p.brand||''; $('#p_subbrand').value=p.subbrand||'';
          $('#p_year').value=p.year||''; $('#p_price').value=p.price_toman||''; $('#p_mileage').value=p.mileage_km||'';
          $('#p_used').checked=!!p.used; $('#p_birang').checked=!!p.birang; $('#p_bedun').checked=!!p.bedun;
          $('#p_retarder').checked=!!p.retarder; $('#p_intarder').checked=!!p.intarder; $('#p_sold').checked=!!p.sold;
          $('#p_insta').value=p.insta_url||''; $('#p_desc').value=p.description||'';
          state.uploads = (p.images||[]).map(u=>({file:null,url:u}));
          renderUploadPreview();
          window.scrollTo({top:document.body.scrollHeight, behavior:'smooth'});
        }
      };
      box.appendChild(card);
    });
  }

  // Ø¨Ø²Ø±Ú¯â€ŒÙ†Ù…Ø§ÛŒÛŒ
  function openModal(url){ const m=$('#modal'); $('#modalImg').src=url; m.style.display='flex'; }

  // ------------------ (Ø¬) Ø¢Ù¾Ù„ÙˆØ¯ ÙˆØ§Ù‚Ø¹ÛŒ Ø¨Ø§ Signed URL ------------------
  $('#p_images').onchange = async (e)=>{
    const files = Array.from(e.target.files || []);
    for (const f of files) {
      const url = await uploadFileToSupabase(f);
      if (url) state.uploads.push({ file:null, url });
    }
    renderUploadPreview();
  };

  async function uploadFileToSupabase(file){
    try{
      // 1) Ø§Ø² Ø³Ø±ÙˆØ± URL Ø§Ù…Ø¶Ø§Ø´Ø¯Ù‡ Ø¨Ú¯ÛŒØ±
      const body = {
        filename: file.name,
        initData: tg?.initData || '',
        editorUser: (state.role==='editor' ? state.username : undefined)
      };
      const r1 = await fetch('/api/upload-url', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify(body)
      });
      const j1 = await r1.json();
      if(!j1.ok) throw new Error(j1.error || 'upload_url_failed');

      // 2) Ø¢Ù¾Ù„ÙˆØ¯ Ù…Ø³ØªÙ‚ÛŒÙ… Ø¨Ù‡ Supabase
      const up = await SUPA.storage
        .from(j1.bucket)
        .uploadToSignedUrl(j1.path, j1.token, file, {
          contentType: file.type || 'application/octet-stream',
          upsert: false
        });
      if (up.error) throw new Error(up.error.message);

      // 3) URL Ø¹Ù…ÙˆÙ…ÛŒ
      return j1.publicUrl;
    }catch(e){
      alert('Ø®Ø·Ø§ Ø¯Ø± Ø¢Ù¾Ù„ÙˆØ¯: ' + String(e));
      return null;
    }
  }

  function renderUploadPreview(){
    const g=$('#p_gallery'); g.innerHTML='';
    state.uploads.forEach((u)=>{ const img=document.createElement('img'); img.src=u.url; img.onclick=()=>openModal(u.url); g.appendChild(img); });
  }

  // Ø°Ø®ÛŒØ±Ù‡ Ù¾Ø³Øª
  $('#savePost').onclick = async ()=>{
    const s=$('#savePostStatus'); s.textContent='Ø¯Ø± Ø­Ø§Ù„ Ø°Ø®ÛŒØ±Ù‡â€¦';
    const payload = {
      id: $('#p_id').value || undefined,
      title: $('#p_title').value,
      brand: $('#p_brand').value,
      subbrand: $('#p_subbrand').value,
      year: Number($('#p_year').value||0)||null,
      price_toman: Number($('#p_price').value||0)||0,
      mileage_km: Number($('#p_mileage').value||0)||null,
      used: $('#p_used').checked,
      birang: $('#p_birang').checked,
      bedun_abrang: $('#p_bedun').checked,
      retarder: $('#p_retarder').checked,
      intarder: $('#p_intarder').checked,
      sold: $('#p_sold').checked,
      insta_url: $('#p_insta').value,
      description: $('#p_desc').value,
      images: state.uploads.map(u=>u.url)
    };
    const r = await fetch('/api/posts',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({ initData: tg?.initData||'', payload, editorUser: state.role==='editor'?state.username:undefined })});
    const j = await r.json();
    s.textContent = j.ok ? 'Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯ âœ…' : ('Ø®Ø·Ø§: '+(j.error||''));
    if(j.ok){ $('#p_id').value=''; state.uploads=[]; renderUploadPreview(); loadPosts(); }
  };

  // ÙÛŒÙ„ØªØ±Ù‡Ø§
  function fillBrandFilter(){ const sel = $('#f_brand'); sel.innerHTML='<option value="">Ù‡Ù…Ù‡ Ø¨Ø±Ù†Ø¯Ù‡Ø§</option>'; Object.keys(BRANDS).forEach(b=>{ const o=document.createElement('option'); o.value=b;o.textContent=b; sel.appendChild(o); }); }
  $('#applyFilters').onclick = loadPosts;
  $('#resetFilters').onclick = ()=>{ ['f_brand','f_year','f_min','f_max'].forEach(id=>$('#'+id).value=''); ['f_used','f_zero','f_birang','f_bedun','f_retarder','f_intarder'].forEach(id=>$('#'+id).checked=false); loadPosts(); };

  // Ø´Ø±ÙˆØ¹
  (async ()=>{
    try{
      await initSupabaseClient();        // â† (Ø¨) Ø³Ø§Ø®Øª Ú©Ù„Ø§ÛŒÙ†Øª ÙØ±Ø§Ù†Øª
      await getMe();
      await loadConfig();
      fillBrandFilter();
      await loadPosts();
      fetch('/api/track',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({action:'visit',meta:{ts:Date.now()}})});
    }catch(e){ debug('init error',String(e)); }
  })();
})();
</script>
</body>
</html>
