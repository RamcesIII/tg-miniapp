<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Telegram Mini App</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body{font-family:sans-serif;margin:0;padding:24px;background:var(--tg-theme-bg-color,#fff);color:var(--tg-theme-text-color,#111)}
    .wrap{max-width:720px;margin:0 auto}
    .card{background:var(--tg-theme-secondary-bg-color,#f5f5f5);border-radius:16px;padding:16px;box-shadow:0 2px 10px rgba(0,0,0,.06);margin:12px 0}
    h1{margin:0 0 8px;font-size:20px}
    label{display:block;margin-top:8px}
    textarea,input{width:100%;padding:10px;border-radius:10px;border:1px solid #ddd;background:transparent;color:inherit}
    button{padding:10px 14px;border-radius:10px;border:0;cursor:pointer}
    .hidden{display:none}
    #debug{font:12px/1.4 monospace;opacity:.85;white-space:pre-wrap;direction:ltr}
  </style>
</head>
<body>
<div class="wrap">
  <!-- Ù†Ù…Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø± -->
  <div class="card">
    <h1>Ù…ÛŒÙ†ÛŒâ€ŒØ§Ù¾ Ù†Ù…ÙˆÙ†Ù‡</h1>
    <div id="welcome">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒâ€¦</div>
  </div>

  <div class="card">
    <h1>Ù…Ù†Ùˆ</h1>
    <ul id="menu"></ul>
  </div>

  <!-- Ù¾Ù†Ù„ Ø§Ø¯Ù…ÛŒÙ† -->
  <div id="adminPanel" class="card hidden">
    <h1>Ù¾Ù†Ù„ Ø§Ø¯Ù…ÛŒÙ† ðŸ‘‘</h1>
    <label>Ù…ØªÙ† Ø®ÙˆØ´â€ŒØ¢Ù…Ø¯</label>
    <textarea id="welcomeInput" rows="3"></textarea>

    <label>Ù…Ù†Ùˆ (JSON)</label>
    <textarea id="menuInput" rows="6">[]</textarea>

    <div style="margin-top:10px">
      <button id="saveBtn">Ø°Ø®ÛŒØ±Ù‡</button>
      <span id="saveStatus"></span>
    </div>
  </div>

  <!-- Ø¨Ø®Ø´ Ø¯ÛŒØ¨Ø§Ú¯ -->
  <div class="card">
    <h1>Debug</h1>
    <div id="debug">startingâ€¦</div>
  </div>
</div>

<script>
(function(){
  const tg = window.Telegram?.WebApp;
  if (tg) tg.expand();

  const debug = (...args)=> {
    const el = document.getElementById('debug');
    el.textContent += '\n' + args.map(x => {
      try { return typeof x === 'string' ? x : JSON.stringify(x); }
      catch { return String(x); }
    }).join(' ');
  };

  const state = { isAdmin:false, config:{ welcome_text:'', menu:[] } };

  // Ø±Ù†Ø¯Ø± Ø±Ø§Ø¨Ø· Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø¨Ø± Ø§Ø³Ø§Ø³ state
  function render(){
    const cfg = state.config || {welcome_text:'', menu:[]};
    document.getElementById('welcome').textContent = cfg.welcome_text || 'Ø³Ù„Ø§Ù…!';
    const ul = document.getElementById('menu');
    ul.innerHTML = '';
    (cfg.menu || []).forEach(item=>{
      const li = document.createElement('li');
      li.textContent = item.title + (item.path ? ` (${item.path})` : '');
      ul.appendChild(li);
    });

    const admin = document.getElementById('adminPanel');
    if(state.isAdmin){
      admin.classList.remove('hidden');
      document.getElementById('welcomeInput').value = cfg.welcome_text || '';
      document.getElementById('menuInput').value = JSON.stringify(cfg.menu || [], null, 2);
    } else {
      admin.classList.add('hidden');
    }
  }

  // ÙØ±Ø§Ø®ÙˆØ§Ù†ÛŒ APIÙ‡Ø§
  async function getMe(){
    const init = tg?.initData || '';
    const url = '/api/me?initData=' + encodeURIComponent(init);
    const r = await fetch(url);
    const j = await r.json();
    debug('initData.len=', (init||'').length, '| /api/me â†’', j);
    return j;
  }

  async function getConfig(){
    const r = await fetch('/api/config');
    const j = await r.json();
    debug('/api/config GET â†’', j);
    return j;
  }

  async function saveConfig(cfg){
    const r = await fetch('/api/config', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ initData: tg?.initData || '', config: cfg })
    });
    const j = await r.json();
    debug('/api/config POST â†’', j);
    return j;
  }

  // Ø¯Ú©Ù…Ù‡ Ø§ØµÙ„ÛŒ ØªÙ„Ú¯Ø±Ø§Ù… (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)
  if (tg) {
    tg.MainButton.setText('Ø³Ù„Ø§Ù… Ø¨Ú¯Ùˆ');
    tg.MainButton.onClick(()=> tg.showAlert('Ø®ÙˆØ´ Ø§ÙˆÙ…Ø¯ÛŒ! ðŸŒŸ'));
    tg.MainButton.show();
  }

  // Ø°Ø®ÛŒØ±Ù‡ Ø§Ø² Ù¾Ù†Ù„ Ø§Ø¯Ù…ÛŒÙ†
  document.getElementById('saveBtn').onclick = async ()=>{
    const status = document.getElementById('saveStatus');
    status.textContent = 'Ø¯Ø± Ø­Ø§Ù„ Ø°Ø®ÛŒØ±Ù‡â€¦';
    try{
      const newCfg = {
        welcome_text: document.getElementById('welcomeInput').value,
        menu: JSON.parse(document.getElementById('menuInput').value || '[]')
      };
      const res = await saveConfig(newCfg);
      if(res.ok){
        state.config = newCfg;
        render();
        status.textContent = 'Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯ âœ…';
      } else {
        status.textContent = 'Ø®Ø·Ø§: ' + (res.error || 'unknown');
      }
    }catch(e){
      status.textContent = 'JSON Ù…Ù†Ùˆ Ù†Ø§Ø¯Ø±Ø³Øª Ø§Ø³Øª.';
    }
  };

  // Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ
  (async ()=>{
    try{
      const me = await getMe();               // Ø¢ÛŒØ§ Ø§Ø¯Ù…ÛŒÙ†Ù…ØŸ
      state.isAdmin = !!me.is_admin;

      const cfg = await getConfig();          // ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø¹Ù…ÙˆÙ…ÛŒ
      state.config = cfg || { welcome_text:'', menu:[] };

      render();
    }catch(e){
      debug('init error:', String(e));
      document.getElementById('welcome').textContent = 'Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ.';
    }
  })();
})();
</script>
</body>
</html>
