<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Telegram Mini App</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body{font-family:sans-serif;margin:0;padding:24px;background:var(--tg-theme-bg-color,#fff);color:var(--tg-theme-text-color,#111)}
    .wrap{max-width:720px;margin:0 auto}
    .card{background:var(--tg-theme-secondary-bg-color,#f5f5f5);border-radius:16px;padding:16px;box-shadow:0 2px 10px rgba(0,0,0,.06);margin:12px 0}
    h1{margin:0 0 8px;font-size:20px}
    label{display:block;margin-top:8px}
    textarea,input{width:100%;padding:10px;border-radius:10px;border:1px solid #ddd;background:transparent;color:inherit}
    button{padding:10px 14px;border-radius:10px;border:0;cursor:pointer}
    .hidden{display:none}
    #debug{font:12px/1.4 monospace;opacity:.85;white-space:pre-wrap;direction:ltr}
  </style>
</head>
<body>
<div class="wrap">
  <!-- نمای کاربر -->
  <div class="card">
    <h1>مینی‌اپ نمونه</h1>
    <div id="welcome">در حال بارگذاری…</div>
  </div>

  <div class="card">
    <h1>منو</h1>
    <ul id="menu"></ul>
  </div>

  <!-- پنل ادمین -->
  <div id="adminPanel" class="card hidden">
    <h1>پنل ادمین 👑</h1>
    <label>متن خوش‌آمد</label>
    <textarea id="welcomeInput" rows="3"></textarea>

    <label>منو (JSON)</label>
    <textarea id="menuInput" rows="6">[]</textarea>

    <div style="margin-top:10px">
      <button id="saveBtn">ذخیره</button>
      <span id="saveStatus"></span>
    </div>
  </div>

  <!-- بخش دیباگ -->
  <div class="card">
    <h1>Debug</h1>
    <div id="debug">starting…</div>
  </div>
</div>

<script>
(function(){
  const tg = window.Telegram?.WebApp;
  if (tg) tg.expand();

  const debug = (...args)=> {
    const el = document.getElementById('debug');
    el.textContent += '\n' + args.map(x => {
      try { return typeof x === 'string' ? x : JSON.stringify(x); }
      catch { return String(x); }
    }).join(' ');
  };

  const state = { isAdmin:false, config:{ welcome_text:'', menu:[] } };

  // رندر رابط کاربری بر اساس state
  function render(){
    const cfg = state.config || {welcome_text:'', menu:[]};
    document.getElementById('welcome').textContent = cfg.welcome_text || 'سلام!';
    const ul = document.getElementById('menu');
    ul.innerHTML = '';
    (cfg.menu || []).forEach(item=>{
      const li = document.createElement('li');
      li.textContent = item.title + (item.path ? ` (${item.path})` : '');
      ul.appendChild(li);
    });

    const admin = document.getElementById('adminPanel');
    if(state.isAdmin){
      admin.classList.remove('hidden');
      document.getElementById('welcomeInput').value = cfg.welcome_text || '';
      document.getElementById('menuInput').value = JSON.stringify(cfg.menu || [], null, 2);
    } else {
      admin.classList.add('hidden');
    }
  }

  // فراخوانی APIها
  async function getMe(){
    const init = tg?.initData || '';
    const url = '/api/me?initData=' + encodeURIComponent(init);
    const r = await fetch(url);
    const j = await r.json();
    debug('initData.len=', (init||'').length, '| /api/me →', j);
    return j;
  }

  async function getConfig(){
    const r = await fetch('/api/config');
    const j = await r.json();
    debug('/api/config GET →', j);
    return j;
  }

  async function saveConfig(cfg){
    const r = await fetch('/api/config', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ initData: tg?.initData || '', config: cfg })
    });
    const j = await r.json();
    debug('/api/config POST →', j);
    return j;
  }

  // دکمه اصلی تلگرام (اختیاری)
  if (tg) {
    tg.MainButton.setText('سلام بگو');
    tg.MainButton.onClick(()=> tg.showAlert('خوش اومدی! 🌟'));
    tg.MainButton.show();
  }

  // ذخیره از پنل ادمین
  document.getElementById('saveBtn').onclick = async ()=>{
    const status = document.getElementById('saveStatus');
    status.textContent = 'در حال ذخیره…';
    try{
      const newCfg = {
        welcome_text: document.getElementById('welcomeInput').value,
        menu: JSON.parse(document.getElementById('menuInput').value || '[]')
      };
      const res = await saveConfig(newCfg);
      if(res.ok){
        state.config = newCfg;
        render();
        status.textContent = 'ذخیره شد ✅';
      } else {
        status.textContent = 'خطا: ' + (res.error || 'unknown');
      }
    }catch(e){
      status.textContent = 'JSON منو نادرست است.';
    }
  };

  // راه‌اندازی
  (async ()=>{
    try{
      const me = await getMe();               // آیا ادمینم؟
      state.isAdmin = !!me.is_admin;

      const cfg = await getConfig();          // تنظیمات عمومی
      state.config = cfg || { welcome_text:'', menu:[] };

      render();
    }catch(e){
      debug('init error:', String(e));
      document.getElementById('welcome').textContent = 'خطا در بارگذاری.';
    }
  })();
})();
</script>
</body>
</html>
