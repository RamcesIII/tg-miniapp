<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>نمایشگاه کامیون و کشنده میرآخورلی</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>

  <style>
    :root{
      --bg: var(--tg-theme-bg-color,#fff);
      --fg: var(--tg-theme-text-color,#111);
      --muted:#7a7a7a;
      --card: var(--tg-theme-secondary-bg-color,#f7f7f7);
      --primary: var(--tg-theme-button-color,#2ea6ff);
      --primary-fg: var(--tg-theme-button-text-color,#fff);
      --radius:16px; --gap:12px; --shadow:0 2px 12px rgba(0,0,0,.06); --fs:17px;
    }
    *{box-sizing:border-box}
    body{font-family:system-ui,Segoe UI,Roboto,sans-serif;font-size:var(--fs);margin:0;background:var(--bg);color:var(--fg)}
    /* padding-top بیشتر تا زیر دکمه‌های تلگرام بره */
    .wrap{max-width:980px;margin:0 auto;padding:32px 16px 16px}
    .header{display:flex;align-items:center;gap:8px;margin-bottom:12px}
    .back{display:none}
    .back.show{display:inline-flex}
    .back button{border:0;background:var(--card);padding:8px 12px;border-radius:10px;box-shadow:var(--shadow);cursor:pointer}
    h1{margin:0 0 4px 0;font-size:20px}
    .sub{color:var(--muted);margin-bottom:10px}

    .card{background:var(--card);border-radius:var(--radius);padding:14px;box-shadow:var(--shadow);margin:12px 0}

    .btn{display:inline-flex;align-items:center;justify-content:center;border:0;cursor:pointer;border-radius:12px;padding:12px 14px;background:var(--primary);color:var(--primary-fg);text-decoration:none;box-shadow:var(--shadow);transition:transform .05s}
    .btn:active{transform:translateY(1px)}
    .btn-outline{background:transparent;color:var(--fg);border:1px solid #ddd}
    .square{display:block;padding:16px;border-radius:14px;background:var(--card);box-shadow:var(--shadow);text-decoration:none;color:inherit}
    .square+.square{margin-top:10px}
    .square .title{font-weight:600;margin-bottom:6px}
    .square .hint{font-size:13px;color:var(--muted)}
    .grid-2{display:grid;grid-template-columns:1fr;gap:var(--gap)}
    @media(min-width:800px){ .grid-2{grid-template-columns:1fr 1fr} }

    .row{display:flex;gap:8px;flex-wrap:wrap}
    label{display:block;margin-top:8px}
    input,select,textarea{width:100%;padding:10px;border-radius:12px;border:1px solid #ddd;background:transparent;color:inherit}
    .pill{font-size:13px;color:var(--muted)}

    .gallery{display:flex;gap:6px;overflow:auto}
    .gallery img{height:68px;border-radius:10px;cursor:zoom-in}
    .item{border:1px solid #e6e6e6;border-radius:14px;padding:12px;margin:10px 0;background:rgba(0,0,0,.02)}
    .sold{color:#0a7a12;font-weight:700}

    /* FAB ورود مدیران */
    .fab{position:fixed;right:16px;bottom:16px;z-index:10}
    .fab .btn{padding:12px 16px;border-radius:999px}

    /* مدال تصویر با دکمه بازگشت */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.8);display:none;align-items:center;justify-content:center;z-index:50}
    .modal .box{max-width:95vw;max-height:90vh;display:flex;flex-direction:column;gap:8px;align-items:center}
    .modal img{max-width:95vw;max-height:80vh;border-radius:12px}
  </style>
</head>
<body>
<div class="wrap">
  <div class="header">
    <div class="back" id="backWrap"><button id="backBtn">بازگشت</button></div>
    <div>
      <h1>نمایشگاه کامیون و کشنده میرآخورلی</h1>
      <div class="sub">درود بر شما. به اپلیکیشن تلگرامی Truck Mirakhorli خوش آمدید.</div>
    </div>
  </div>

  <div id="view"></div>

  <div class="fab" id="fabLogin"><button class="btn btn-outline" id="openLogin">ورود مدیران</button></div>
</div>

<!-- مدال تصویر -->
<div id="imgModal" class="modal">
  <div class="box">
    <img id="modalImg" src="">
    <button class="btn btn-outline" id="modalClose">بازگشت</button>
  </div>
</div>

<script>
(function(){
  const tg = window.Telegram?.WebApp; tg?.expand();

  // ---------- Supabase Client ----------
  let SUPA=null;
  async function initSupabase(){
    const r = await fetch('/api/public'); const j = await r.json();
    SUPA = window.supabase.createClient(j.supabaseUrl, j.supabaseAnon);
  }

  // ---------- State ----------
  const state = {
    page:'home', role:'public', username:'', token:'',
    config:{ welcome_text:'', menu:[], blocks:[] },
    uploads:[]
  };
  const $ = s=>document.querySelector(s);
  const view = $('#view'), backWrap=$('#backWrap');

  const BRANDS = {
    "Volvo":["FH","FM","FMX","F12","F16"],
    "Scania":["R","S","P","G","T"],
    "Mercedes-Benz":["Actros","Axor","Atego"],
    "MAN":["TGX","TGS","TGA","F2000"],
    "DAF":["XF","CF","LF"],
    "Iveco":["Stralis","Trakker","Eurocargo"],
    "Renault":["T","C","K","Magnum","Premium"],
    "Kamaz":["5490","6520","6460"],
    "Howo":["A7","T7H","T5G"],
    "FAW":["JH6","J5P"],
    "Dongfeng":["KX","KL","KC"],
    "Shacman":["X3000","X5000","M3000"]
  };

  function esc(s){ return String(s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m])); }
  function priceTxt(x){ if(!x) return '—'; return Number(x).toLocaleString('fa-IR')+' تومان'; }

  function setPage(p){ state.page=p; render(); }
  $('#backBtn').onclick = ()=>{
    if($('#imgModal').style.display==='flex'){ $('#imgModal').style.display='none'; return; }
    if(state.page.startsWith('admin.')) setPage('admin');
    else if(state.page==='login') setPage('home');
  };

  // ---------- API ----------
  async function getMe(){
    const q = new URLSearchParams({ initData: tg?.initData||'', token: state.token }).toString();
    const j = await (await fetch('/api/me?'+q)).json();
    state.role = j.role || 'public';
    state.username = j.username || '';
    // اگه ادمین هست → مستقیماً منوی ادمین
    if(j.is_admin){ $('#fabLogin').style.display='none'; setPage('admin'); }
    else { $('#fabLogin').style.display='block'; setPage('home'); }
  }
  async function loginEditor(u,p){
    const j = await (await fetch('/api/login',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({username:u,password:p})})).json();
    if(j.ok){ state.token=j.token; state.role=j.role; state.username=u; setPage('admin'); }
    else alert('یوزر/رمز نامعتبر است');
  }
  async function loadConfig(){ const j = await (await fetch('/api/config')).json(); state.config = Object.assign({welcome_text:'',menu:[],blocks:[]}, j||{}); }
  async function getPosts(params){ const j = await (await fetch('/api/posts?'+new URLSearchParams(params))).json(); return j.items||[]; }
  async function savePost(payload){
    return await (await fetch('/api/posts',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({ initData: tg?.initData||'', payload, editorUser:(state.role==='editor'?state.username:undefined) })})).json();
  }
  async function deletePost(id){
    return await (await fetch('/api/posts',{method:'DELETE',headers:{'Content-Type':'application/json'},body:JSON.stringify({ initData: tg?.initData||'', id })})).json();
  }
  async function uploadFileToSupabase(file){
    const j1 = await (await fetch('/api/upload-url',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({ filename:file.name, initData: tg?.initData||'', editorUser:(state.role==='editor'?state.username:undefined) })})).json();
    if(!j1.ok){ alert(j1.error||'upload error'); return null; }
    const up = await SUPA.storage.from(j1.bucket).uploadToSignedUrl(j1.path, j1.token, file,{contentType:file.type||'application/octet-stream'});
    if(up.error){ alert(up.error.message); return null; }
    return j1.publicUrl;
  }

  // ---------- Views ----------
  function render(){
    backWrap.classList.remove('show');
    if(state.page==='home') return renderHome();
    if(state.page==='login'){ backWrap.classList.add('show'); return renderLogin(); }
    if(state.page==='admin'){ backWrap.classList.add('show'); return renderAdminMenu(); }
    if(state.page==='admin.new'){ backWrap.classList.add('show'); return renderPostForm(); }
    if(state.page==='admin.edit'){ backWrap.classList.add('show'); return renderPostList('edit'); }
    if(state.page==='admin.delete'){ backWrap.classList.add('show'); return renderPostList('delete'); }
  }

  // صفحه کاربر (فیلتر ساده + لیست)
  function renderHome(){
    const brandOptions = Object.keys(BRANDS).map(b=>`<option value="${esc(b)}">${esc(b)}</option>`).join('');
    view.innerHTML = `
      <div class="grid-2">
        <a class="square" href="https://instagram.com/truck.mirakhorli" target="_blank">
          <div class="title">پیج اینستاگرام</div>
          <div class="hint">@truck.mirakhorli</div>
        </a>
        <a class="square" href="tel:09121314226">
          <div class="title">تماس با مشاور</div>
          <div class="hint">09121314226</div>
        </a>
      </div>

      <div class="card">
        <div class="title" style="font-weight:700;margin-bottom:8px">جست‌وجو بر اساس فیلتر</div>
        <label>برند</label>
        <select id="f_brand"><option value="">همه برندها</option>${brandOptions}</select>
        <label>سال ساخت</label>
        <input id="f_year" type="number" placeholder="مثلاً 2019">

        <label style="margin-top:10px">بازهٔ قیمت (تومان)</label>
        <div class="row">
          <input id="r_min" type="range" min="0" max="20000000000" step="10000000">
          <input id="r_max" type="range" min="0" max="20000000000" step="10000000">
        </div>
        <div class="row">
          <input id="f_min" type="number" placeholder="از" style="flex:1">
          <input id="f_max" type="number" placeholder="تا" style="flex:1">
        </div>
        <div class="pill" id="priceLabel"></div>

        <div class="row" style="margin-top:10px">
          <button class="btn" id="apply">اعمال</button>
          <button class="btn btn-outline" id="reset">ریست</button>
        </div>
      </div>

      <div class="card"><div id="posts"></div></div>
    `;
    // اسلایدرها + نمایش با جداکننده هزارگان
    const rmin=$('#r_min'), rmax=$('#r_max'), nmin=$('#f_min'), nmax=$('#f_max'), lbl=$('#priceLabel');
    const fmt=v=>Number(v).toLocaleString('fa-IR');
    const sync=()=>{ let a=+rmin.value, b=+rmax.value; if(a>b){[a,b]=[b,a];} nmin.value=a; nmax.value=b; lbl.textContent=`${fmt(a)} تا ${fmt(b)} تومان`; };
    rmin.oninput=sync; rmax.oninput=sync; sync();

    $('#apply').onclick = ()=> loadAndRenderPosts();
    $('#reset').onclick = ()=>{ $('#f_brand').value=''; $('#f_year').value=''; rmin.value=0; rmax.value=20000000000; sync(); loadAndRenderPosts(); };
    loadAndRenderPosts();
  }

  async function loadAndRenderPosts(){
    const params={};
    if($('#f_brand')){ const b=$('#f_brand').value; if(b) params.brand=b; }
    if($('#f_year')){ const y=$('#f_year').value; if(y) params.year=y; }
    if($('#f_min')){ const mi=$('#f_min').value; if(mi) params.minp=mi; }
    if($('#f_max')){ const ma=$('#f_max').value; if(ma) params.maxp=ma; }
    const items = await getPosts(params);
    const box=$('#posts'); box.innerHTML='';
    items.forEach(p=>{
      const el=document.createElement('div'); el.className='item';
      el.innerHTML=`
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div><b>${esc(p.brand||'')} ${esc(p.subbrand||'')}</b> <span class="pill">سال ${p.year||'—'}</span></div>
          <div>${p.sold?'<span class="sold">✅ فروخته شده است</span>':''}</div>
        </div>
        <div class="pill">${priceTxt(p.price_toman)}</div>
        <div class="gallery"></div>
        ${p.description?`<div class="pill" style="margin-top:6px">${esc(p.description)}</div>`:''}
        <div class="row" style="margin-top:8px">
          ${p.insta_url?`<a class="btn" href="${esc(p.insta_url)}" target="_blank">مشاهده در اینستاگرام</a>`:''}
          <a class="btn btn-outline" href="tel:09121314226">تماس با مشاور</a>
        </div>`;
      const g=el.querySelector('.gallery');
      (p.images||[]).forEach(u=>{ const im=new Image(); im.src=u; im.onclick=()=>openModal(u); g.appendChild(im); });
      box.appendChild(el);
    });
  }

  // صفحه‌ی لاگین
  function renderLogin(){
    view.innerHTML = `
      <div class="card">
        <div class="square">
          <div class="title">ورود مدیران</div>
          <div class="hint">نام کاربری و رمز عبور را وارد کنید</div>
          <label>نام کاربری</label><input id="lu" placeholder="username">
          <label>رمز عبور</label><input id="lp" type="password" placeholder="password">
          <div class="row" style="margin-top:10px">
            <button class="btn" id="doLogin">ورود</button>
            <button class="btn btn-outline" id="cancelLogin">انصراف</button>
          </div>
        </div>
      </div>`;
    $('#doLogin').onclick = ()=> loginEditor($('#lu').value.trim(), $('#lp').value);
    $('#cancelLogin').onclick = ()=> setPage('home');
  }
  $('#openLogin').onclick = ()=> setPage('login');

  // منوی ادمین (سه آیتم جدا)
  function renderAdminMenu(){
    view.innerHTML = `
      <a class="square" id="m_new"><div class="title">پست جدید</div><div class="hint">افزودن آگهی با آپلود تصاویر</div></a>
      <a class="square" id="m_edit"><div class="title">ویرایش پست‌ها</div><div class="hint">لیست کامل برای ویرایش</div></a>
      <a class="square" id="m_delete"><div class="title">حذف پست‌ها</div><div class="hint">فقط Owner می‌تواند حذف کند</div></a>`;
    $('#m_new').onclick = ()=> setPage('admin.new');
    $('#m_edit').onclick = ()=> setPage('admin.edit');
    $('#m_delete').onclick = ()=> setPage('admin.delete');
  }

  // فرم پست جدید (همان قبلی، بدون فیلتر)
  function renderPostForm(){
    view.innerHTML = `
      <div class="card">
        <div class="row">
          <input id="p_id" type="hidden">
          <input id="p_title" placeholder="عنوان">
          <input id="p_brand" placeholder="برند (مثلاً Volvo)">
          <input id="p_subbrand" placeholder="سری/مدل (مثلاً FH)">
        </div>
        <div class="row">
          <input id="p_year" type="number" placeholder="سال (مثلاً 2019)">
          <input id="p_price" type="number" placeholder="قیمت (تومان)">
          <input id="p_mileage" type="number" placeholder="کارکرد (کیلومتر)">
        </div>
        <label>لینک پست اینستاگرام</label><input id="p_insta" placeholder="https://instagram.com/...">
        <label>توضیحات</label><textarea id="p_desc" rows="3"></textarea>

        <label>تصاویر (درگ‌اَند‌دراپ یا انتخاب)</label>
        <input id="p_images" type="file" multiple accept="image/*">
        <div id="p_gallery" class="gallery"></div>

        <div class="row" style="margin-top:10px">
          <button class="btn" id="savePost">ثبت/ذخیره</button>
        </div>
      </div>`;
    $('#p_images').onchange = async (e)=>{
      const files = Array.from(e.target.files||[]);
      state.uploads=[];
      for(const f of files){ const url=await uploadFileToSupabase(f); if(url) state.uploads.push({url}); }
      renderUploadPreview();
    };
    function renderUploadPreview(){ const g=$('#p_gallery'); g.innerHTML=''; state.uploads.forEach(u=>{ const im=new Image(); im.src=u.url; im.onclick=()=>openModal(u.url); g.appendChild(im); }); }
    $('#savePost').onclick = async ()=>{
      const payload = {
        title: $('#p_title').value, brand: $('#p_brand').value, subbrand: $('#p_subbrand').value,
        year: Number($('#p_year').value)||null, price_toman: Number($('#p_price').value)||0, mileage_km: Number($('#p_mileage').value)||null,
        insta_url: $('#p_insta').value, description: $('#p_desc').value, images: state.uploads.map(u=>u.url)
      };
      const j = await savePost(payload);
      alert(j.ok?'ذخیره شد ✅':('خطا: '+(j.error||'')));
      if(j.ok){ state.uploads=[]; setPage('admin'); }
    };
  }

  // لیست ویرایش/حذف
  async function renderPostList(mode){
    const items = await getPosts({});
    view.innerHTML = items.map(p=>`
      <div class="item">
        <div><b>${esc(p.brand||'')} ${esc(p.subbrand||'')}</b> <span class="pill">سال ${p.year||'—'}</span> – ${priceTxt(p.price_toman)}</div>
        <div class="row" style="margin-top:6px">
          ${mode==='edit' ? `<button class="btn btn-outline" data-edit="${p.id}">ویرایش</button>`:''}
          ${mode==='delete' ? `<button class="btn" style="background:#ff4d4f" data-del="${p.id}">حذف</button>`:''}
        </div>
      </div>
    `).join('') || '<div class="pill">موردی یافت نشد.</div>';

    view.onclick = async e=>{
      const id = e.target.dataset.edit || e.target.dataset.del; if(!id) return;
      if(e.target.dataset.edit){
        const p = items.find(x=>x.id==id);
        setPage('admin.new');
        setTimeout(()=>{
          $('#p_title').value=p.title||''; $('#p_brand').value=p.brand||''; $('#p_subbrand').value=p.subbrand||'';
          $('#p_year').value=p.year||''; $('#p_price').value=p.price_toman||''; $('#p_mileage').value=p.mileage_km||'';
          $('#p_insta').value=p.insta_url||''; $('#p_desc').value=p.description||'';
          state.uploads=(p.images||[]).map(u=>({url:u}));
          const g=$('#p_gallery'); g.innerHTML=''; state.uploads.forEach(u=>{ const im=new Image(); im.src=u.url; im.onclick=()=>openModal(u.url); g.appendChild(im); });
          $('#savePost').onclick = async ()=>{
            const payload = {
              id:p.id,
              title: $('#p_title').value, brand: $('#p_brand').value, subbrand: $('#p_subbrand').value,
              year: Number($('#p_year').value)||null, price_toman: Number($('#p_price').value)||0, mileage_km: Number($('#p_mileage').value)||null,
              insta_url: $('#p_insta').value, description: $('#p_desc').value, images: state.uploads.map(u=>u.url)
            };
            const j = await savePost(payload);
            alert(j.ok?'ذخیره شد ✅':('خطا: '+(j.error||'')));
            if(j.ok){ setPage('admin'); }
          };
        },0);
      }
      if(e.target.dataset.del){
        if(state.role!=='owner'){ alert('حذف فقط برای Owner مجاز است'); return; }
        if(confirm('این پست حذف شود؟')){
          const j = await deletePost(Number(id));
          alert(j.ok?'حذف شد ✅':('خطا: '+(j.error||'')));
          if(j.ok) renderPostList('delete');
        }
      }
    };
  }

  // مدال تصویر + بازگشت
  function openModal(url){ $('#modalImg').src=url; $('#imgModal').style.display='flex'; }
  $('#modalClose').onclick = ()=> $('#imgModal').style.display='none';

  // شروع
  (async ()=>{
    await initSupabase();
    await loadConfig();
    await getMe();   // خودش بسته به نقش، صفحه مناسب رو setPage می‌کند
  })();
})();
</script>
</body>
</html>
