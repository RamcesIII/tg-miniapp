<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Telegram Mini App</title>

  <!-- Telegram WebApp SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <!-- Drag & Drop (SortableJS) -->
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>

  <style>
    body{font-family:sans-serif;margin:0;padding:24px;background:var(--tg-theme-bg-color,#fff);color:var(--tg-theme-text-color,#111)}
    .wrap{max-width:820px;margin:0 auto}
    .card{background:var(--tg-theme-secondary-bg-color,#f5f5f5);border-radius:16px;padding:16px;box-shadow:0 2px 10px rgba(0,0,0,.06);margin:12px 0}
    h1{margin:0 0 8px;font-size:20px}
    h2{margin:8px 0;font-size:16px;opacity:.8}
    button{padding:10px 14px;border-radius:10px;border:0;cursor:pointer}
    input,textarea,select{width:100%;padding:10px;border-radius:10px;border:1px solid #ddd;background:transparent;color:inherit}
    .hidden{display:none}
    ul{list-style:none;margin:0;padding:0}
    .item{display:flex;align-items:center;gap:8px;padding:10px;border:1px solid #ddd;border-radius:12px;margin:8px 0;background:rgba(0,0,0,.02)}
    .handle{cursor:grab;font-weight:bold;padding:0 8px}
    .grow{flex:1}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    .pill{font-size:12px;opacity:.7}
    .block{border:1px dashed #ccc;border-radius:12px;padding:12px;margin:8px 0;background:rgba(0,0,0,.02)}
    .btn{background:var(--tg-theme-button-color,#2ea6ff);color:var(--tg-theme-button-text-color,#fff)}
    #debug{font:12px/1.4 monospace;opacity:.85;white-space:pre-wrap;direction:ltr}
  </style>
</head>
<body>
<div class="wrap">
  <!-- Ù†Ù…Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø± -->
  <div class="card">
    <h1>Ù…ÛŒÙ†ÛŒâ€ŒØ§Ù¾ Ù†Ù…ÙˆÙ†Ù‡</h1>
    <div id="welcome">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒâ€¦</div>
  </div>

  <div class="card">
    <h1>Ù…Ù†Ùˆ</h1>
    <ul id="menuView"></ul>
  </div>

  <div class="card">
    <h1>Ù…Ø­ØªÙˆØ§</h1>
    <div id="blocksView"></div>
  </div>

  <!-- Ù¾Ù†Ù„ Ø§Ø¯Ù…ÛŒÙ† Ø¨Ø§ Drag & Drop -->
  <div id="adminPanel" class="card hidden">
    <h1>Ù¾Ù†Ù„ Ø§Ø¯Ù…ÛŒÙ† ğŸ‘‘</h1>

    <label>Ù…ØªÙ† Ø®ÙˆØ´â€ŒØ¢Ù…Ø¯</label>
    <textarea id="welcomeInput" rows="3"></textarea>

    <div class="row" style="margin-top:12px">
      <div class="grow">
        <h2 class="pill">Ù…Ù†ÙˆÛŒ Ú©Ø§Ø±Ø¨Ø± (Drag & Drop)</h2>
        <ul id="menuEditor"></ul>
      </div>
    </div>

    <div class="row">
      <input id="newTitle" placeholder="Ø¹Ù†ÙˆØ§Ù† Ù…Ù†Ùˆ (Ù…Ø«Ù„Ø§Ù‹: Ø®Ø§Ù†Ù‡)"/>
      <input id="newPath" placeholder="Ù…Ø³ÛŒØ± (Ù…Ø«Ù„Ø§Ù‹: / ÛŒØ§ /about)"/>
      <button id="addItemBtn">Ø§ÙØ²ÙˆØ¯Ù† Ø¢ÛŒØªÙ…</button>
    </div>

    <div style="margin:12px 0"></div>
    <h2 class="pill">Ø¨Ù„ÙˆÚ©â€ŒÙ‡Ø§ÛŒ Ù…Ø­ØªÙˆØ§ (Drag & Drop)</h2>
    <div id="blocksEditor"></div>

    <div class="row" style="margin-top:8px">
      <select id="blockType">
        <option value="text">Ù…ØªÙ†</option>
        <option value="image">ØªØµÙˆÛŒØ±</option>
        <option value="button">Ø¯Ú©Ù…Ù‡</option>
      </select>
      <button id="addBlockBtn">Ø§ÙØ²ÙˆØ¯Ù† Ø¨Ù„ÙˆÚ©</button>
    </div>

    <div class="row" style="margin-top:12px">
      <button id="saveBtn" class="btn">Ø°Ø®ÛŒØ±Ù‡</button>
      <span id="saveStatus"></span>
    </div>
  </div>

  <!-- Ø¨Ø®Ø´ Ø¯ÛŒØ¨Ø§Ú¯ -->
  <div class="card">
    <h1>Debug</h1>
    <div id="debug">startingâ€¦</div>
  </div>
</div>

<script>
(function(){
  const tg = window.Telegram?.WebApp; tg?.expand();

  const debug = (...args)=> {
    const el = document.getElementById('debug');
    el.textContent += '\n' + args.map(x => {
      try { return typeof x === 'string' ? x : JSON.stringify(x); }
      catch { return String(x); }
    }).join(' ');
  };

  const state = {
    isAdmin:false,
    config:{ welcome_text:'', menu:[], blocks:[] }
  };

  // ---------- UI Ø±Ù†Ø¯Ø± Ú©Ø§Ø±Ø¨Ø± ----------
  function renderUserView(){
    // Welcome
    document.getElementById('welcome').textContent =
      state.config.welcome_text || 'Ø³Ù„Ø§Ù…!';

    // Menu
    const ul = document.getElementById('menuView');
    ul.innerHTML = '';
    (state.config.menu || []).forEach(item=>{
      const li = document.createElement('li');
      li.className = 'item';
      li.innerHTML = `
        <div class="grow"><b>${escapeHtml(item.title||'')}</b>
          <span class="pill">${escapeHtml(item.path||'')}</span>
        </div>`;
      ul.appendChild(li);
    });

    // Blocks
    const bv = document.getElementById('blocksView');
    bv.innerHTML = '';
    (state.config.blocks || []).forEach(block=>{
      bv.appendChild(renderBlockView(block));
    });
  }

  function renderBlockView(block){
    const wrap = document.createElement('div');
    wrap.className = 'block';
    if(block.type === 'text'){
      wrap.textContent = block.text || '';
    } else if(block.type === 'image'){
      const img = document.createElement('img');
      img.src = block.url || '';
      img.alt = block.alt || '';
      img.style.maxWidth = '100%';
      img.style.borderRadius = '12px';
      wrap.appendChild(img);
      if(block.caption){
        const cap = document.createElement('div');
        cap.className = 'pill';
        cap.textContent = block.caption;
        wrap.appendChild(cap);
      }
    } else if(block.type === 'button'){
      const btn = document.createElement('button');
      btn.className = 'btn';
      btn.textContent = block.text || 'Ø¯Ú©Ù…Ù‡';
      btn.onclick = () => {
        if(block.href) location.hash = block.href;
      };
      wrap.appendChild(btn);
    } else {
      wrap.textContent = 'Unsupported block';
    }
    return wrap;
  }

  // ---------- UI Ù¾Ù†Ù„ Ø§Ø¯Ù…ÛŒÙ† ----------
  function renderAdmin(){
    const admin = document.getElementById('adminPanel');
    if(!state.isAdmin){ admin.classList.add('hidden'); return; }
    admin.classList.remove('hidden');

    document.getElementById('welcomeInput').value = state.config.welcome_text || '';

    // Ù…Ù†Ùˆ
    const ul = document.getElementById('menuEditor');
    ul.innerHTML = '';
    (state.config.menu || []).forEach((item, idx)=>{
      ul.appendChild(menuItemRow(item, idx));
    });
    new Sortable(ul, {
      handle: '.handle',
      animation: 150,
      onEnd: () => {
        const rows = [...ul.querySelectorAll('li')];
        state.config.menu = rows.map(li => ({
          title: li.dataset.title,
          path: li.dataset.path
        }));
        renderUserView();
      }
    });

    // Ø¨Ù„ÙˆÚ©â€ŒÙ‡Ø§
    const be = document.getElementById('blocksEditor');
    be.innerHTML = '';
    (state.config.blocks || []).forEach((b, idx)=>{
      be.appendChild(blockEditorRow(b, idx));
    });
    new Sortable(be, {
      handle: '.handle',
      animation: 150,
      onEnd: () => {
        const rows = [...be.children];
        state.config.blocks = rows.map(el => JSON.parse(el.dataset.block));
        renderUserView();
      }
    });
  }

  function menuItemRow(item, idx){
    const li = document.createElement('li');
    li.className = 'item';
    li.dataset.title = item.title || '';
    li.dataset.path  = item.path || '';
    li.innerHTML = `
      <span class="handle">â˜°</span>
      <div class="grow">
        <div><b>${escapeHtml(item.title||'')}</b></div>
        <div class="pill">${escapeHtml(item.path||'')}</div>
      </div>
      <button data-act="edit">ÙˆÛŒØ±Ø§ÛŒØ´</button>
      <button data-act="del">Ø­Ø°Ù</button>
    `;
    li.onclick = (e)=>{
      const act = e.target?.dataset?.act;
      if(act==='del'){
        state.config.menu.splice(idx,1);
        renderAdmin(); renderUserView();
      }
      if(act==='edit'){
        const t = prompt('Ø¹Ù†ÙˆØ§Ù† Ø¬Ø¯ÛŒØ¯:', li.dataset.title || '');
        if(t===null) return;
        const p = prompt('Ù…Ø³ÛŒØ± Ø¬Ø¯ÛŒØ¯:', li.dataset.path || '');
        if(p===null) return;
        state.config.menu[idx] = { title:t, path:p };
        renderAdmin(); renderUserView();
      }
    };
    return li;
  }

  function blockEditorRow(block, idx){
    const row = document.createElement('div');
    row.className = 'item';
    row.dataset.block = JSON.stringify(block);

    row.innerHTML = `
      <span class="handle">â˜°</span>
      <div class="grow"></div>
      <button data-act="edit">ÙˆÛŒØ±Ø§ÛŒØ´</button>
      <button data-act="del">Ø­Ø°Ù</button>
    `;

    const body = row.querySelector('.grow');
    body.appendChild(renderBlockSummary(block));

    row.onclick = (e)=>{
      const act = e.target?.dataset?.act;
      if(act==='del'){
        state.config.blocks.splice(idx,1);
        renderAdmin(); renderUserView();
      }
      if(act==='edit'){
        editBlock(block, (updated)=>{
          state.config.blocks[idx] = updated;
          renderAdmin(); renderUserView();
        });
      }
    };
    return row;
  }

  function renderBlockSummary(b){
    const s = document.createElement('div');
    s.innerHTML = `
      <div><b>Ù†ÙˆØ¹:</b> ${escapeHtml(b.type||'')}</div>
      ${b.type==='text' ? `<div class="pill">${escapeHtml((b.text||'').slice(0,60))}</div>`:''}
      ${b.type==='image' ? `<div class="pill">${escapeHtml(b.url||'')}</div>`:''}
      ${b.type==='button'? `<div class="pill">${escapeHtml(b.text||'')} â†’ ${escapeHtml(b.href||'')}</div>`:''}
    `;
    return s;
  }

  function editBlock(block, onSave){
    if(block.type==='text'){
      const t = prompt('Ù…ØªÙ†:', block.text || '');
      if(t===null) return;
      onSave({ type:'text', text:t });
    } else if(block.type==='image'){
      const url = prompt('Ø¢Ø¯Ø±Ø³ ØªØµÙˆÛŒØ±:', block.url || '');
      if(url===null) return;
      const alt = prompt('ALT (Ø§Ø®ØªÛŒØ§Ø±ÛŒ):', block.alt || '');
      if(alt===null) return;
      const cap = prompt('Ú©Ù¾Ø´Ù† (Ø§Ø®ØªÛŒØ§Ø±ÛŒ):', block.caption || '');
      if(cap===null) return;
      onSave({ type:'image', url, alt, caption: cap });
    } else if(block.type==='button'){
      const text = prompt('Ù…ØªÙ† Ø¯Ú©Ù…Ù‡:', block.text || '');
      if(text===null) return;
      const href = prompt('Ù…Ø³ÛŒØ±/Ù„ÛŒÙ†Ú© (Ù…Ø«Ù„Ø§Ù‹ /go ):', block.href || '');
      if(href===null) return;
      onSave({ type:'button', text, href });
    }
  }

  function escapeHtml(s){
    return String(s||'').replace(/[&<>"']/g, m=>({
      '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
    }[m]));
  }

  // ---------- API ----------
  async function getMe(){
    const init = tg?.initData || '';
    const r = await fetch('/api/me?initData=' + encodeURIComponent(init));
    const j = await r.json();
    debug('initData.len=', (init||'').length, '| /api/me â†’', j);
    return j;
  }
  async function getConfig(){
    const r = await fetch('/api/config');
    const txt = await r.text();
    try { const j = JSON.parse(txt); debug('/api/config GET â†’', j); return j; }
    catch { debug('/api/config RAW â†’', txt.slice(0,250)); throw new Error('config_not_json'); }
  }
  async function saveConfig(cfg){
    const r = await fetch('/api/config', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ initData: tg?.initData || '', config: cfg })
    });
    const j = await r.json().catch(()=>({ok:false,error:'not_json'}));
    debug('/api/config POST â†’', j);
    return j;
  }

  // Ø§ÙØ²ÙˆØ¯Ù† Ø¢ÛŒØªÙ…/Ø¨Ù„ÙˆÚ©
  document.getElementById('addItemBtn').onclick = ()=>{
    const t = document.getElementById('newTitle').value.trim();
    const p = document.getElementById('newPath').value.trim();
    if(!t) return alert('Ø¹Ù†ÙˆØ§Ù† Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
    state.config.menu = state.config.menu || [];
    state.config.menu.push({ title:t, path:p||'/' });
    document.getElementById('newTitle').value='';
    document.getElementById('newPath').value='';
    renderAdmin(); renderUserView();
  };

  document.getElementById('addBlockBtn').onclick = ()=>{
    const type = document.getElementById('blockType').value;
    const def = type==='text'   ? {type:'text', text:'Ù…ØªÙ† Ù†Ù…ÙˆÙ†Ù‡'} :
                type==='image'  ? {type:'image', url:'https://placehold.co/600x300', alt:'', caption:''} :
                                   {type:'button', text:'Ø¨Ø²Ù† Ø¨Ø±ÛŒÙ…', href:'/go'};
    state.config.blocks = state.config.blocks || [];
    state.config.blocks.push(def);
    renderAdmin(); renderUserView();
  };

  // Ø°Ø®ÛŒØ±Ù‡
  document.getElementById('saveBtn').onclick = async ()=>{
    const status = document.getElementById('saveStatus');
    status.textContent = 'Ø¯Ø± Ø­Ø§Ù„ Ø°Ø®ÛŒØ±Ù‡â€¦';
    const cfg = {
      welcome_text: document.getElementById('welcomeInput').value,
      menu: state.config.menu || [],
      blocks: state.config.blocks || []
    };
    const res = await saveConfig(cfg);
    status.textContent = res.ok ? 'Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯ âœ…' : ('Ø®Ø·Ø§: ' + (res.error||''));
  };

  // Ø¯Ú©Ù…Ù‡â€ŒÛŒ Ø§ØµÙ„ÛŒ ØªÙ„Ú¯Ø±Ø§Ù… (Ù†Ù…ÙˆÙ†Ù‡)
  if (tg) {
    tg.MainButton.setText('Ø³Ù„Ø§Ù… Ø¨Ú¯Ùˆ');
    tg.MainButton.onClick(()=> tg.showAlert('Ø®ÙˆØ´ Ø§ÙˆÙ…Ø¯ÛŒ! ğŸŒŸ'));
    tg.MainButton.show();
  }

  // Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ
  (async ()=>{
    try{
      const me  = await getMe();         // Ø¢ÛŒØ§ Ø§Ø¯Ù…ÛŒÙ†ØŸ
      state.isAdmin = !!me.is_admin;

      const cfg = await getConfig();     // ØªÙ†Ø¸ÛŒÙ…Ø§Øª
      state.config = Object.assign({ welcome_text:'', menu:[], blocks:[] }, cfg||{});

      renderUserView();
      renderAdmin();
    }catch(e){
      debug('init error:', String(e));
      document.getElementById('welcome').textContent = 'Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ.';
    }
  })();
})();
</script>
</body>
</html>
